var U=Object.defineProperty;var A=(c,a,d)=>a in c?U(c,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[a]=d;var g=(c,a,d)=>A(c,typeof a!="symbol"?a+"":a,d);(function(){"use strict";const h=class h{constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async insertPhotoIntoMessengerChat(r){let n=this.findChatArea();if(!n)throw new Error("Không tìm thấy khu vực chat. Vui lòng mở box chat trước!");try{const e=await fetch(r,{mode:"cors",credentials:"omit"});if(!e.ok)throw new Error("Không thể tải ảnh từ URL");const s=await e.blob(),i=new File([s],"image.jpg",{type:s.type||"image/jpeg"}),o=new DataTransfer;o.items.add(i);const w=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:o});if(n.focus(),await new Promise(f=>setTimeout(f,50)),!n.dispatchEvent(w))throw new Error("Không thể gửi ảnh vào chat");return await new Promise(f=>setTimeout(f,100)),!0}catch(e){throw console.error("[The extension] Lỗi khi gửi ảnh:",e),e}}findChatArea(){switch(window.location.hostname){case"www.messenger.com":case"www.facebook.com":return document.querySelector('div[role="textbox"][contenteditable="true"]');case"voz.vn":return document.querySelector(".fr-element.fr-view.fr-element-scroll-visible");default:return document.querySelector("input")}}};g(h,"instance");let c=h;function a(t){t.style.filter="blur(20px)",t.style.transition="filter 0.3s ease"}const u=class u{constructor(){g(this,"checkedElements",new Set)}static getInstance(){return u.instance||(u.instance=new u),u.instance}async checkMediaWithBackground(r){try{return new Promise(n=>{chrome.runtime.sendMessage({type:"CHECK_NSFW",mediaUrl:r},e=>{if(chrome.runtime.lastError){console.error("[The extension]: Lỗi khi gửi message:",chrome.runtime.lastError),n(!1);return}n(e.isNsfw||!1)})})}catch(n){return console.error("[The extension]: Lỗi khi kiểm tra media:",n),!1}}monitorMedia(){chrome.storage.local.get("config_settings-key",async r=>{r["config_settings-key"].nsfwBlockEnabled&&(new MutationObserver(async e=>{for(const s of e)s.addedNodes.length&&await this.checkNewMediaElements()}).observe(document.body,{childList:!0,subtree:!0}),this.checkNewMediaElements())})}async checkNewMediaElements(){var n;const r=document.querySelectorAll("img, video");for(const e of Array.from(r)){if(this.checkedElements.has(e))continue;let s="";e instanceof HTMLImageElement?s=e.src:e instanceof HTMLVideoElement?s=e.src||((n=e.querySelector("source"))==null?void 0:n.src)||"":(e instanceof HTMLIFrameElement||e instanceof HTMLEmbedElement)&&(s=e.src),s&&(this.checkedElements.add(e),await this.checkMediaWithBackground(s)&&a(e))}}};g(u,"instance");let d=u;function v(){window.hasRegisteredListener=window.hasRegisteredListener||!1,window.isOverlayOpen=window.isOverlayOpen||!1}v();const b=d.getInstance(),M=c.getInstance();function k(){if(window.hasRegisteredListener){console.log("[The extension]: Listener already registered, skipping...");return}chrome.runtime.onMessage.addListener((t,r,n)=>{if(t.type==="INSERT_PHOTO"&&t.photoUrl)return M.insertPhotoIntoMessengerChat(t.photoUrl).then(()=>n({success:!0})).catch(e=>{console.error("[The extension] Error inserting photo:",e),n({success:!1,error:e.message})}),!0;t.type==="OPEN_CROP_OVERLAY"&&(window.isOverlayOpen?console.log("[The extension]: Overlay already open, skipping..."):x(),n({success:!0}))}),window.hasRegisteredListener=!0,console.log("[The extension]: Listener registered successfully")}function x(){window.isOverlayOpen=!0;const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.background="rgba(0, 0, 0, 0.5)",t.style.zIndex="99999",t.style.cursor="cell";let r=0,n=0,e=0,s=0,i=!1,o=document.createElement("div");const w=()=>{t&&document.body.contains(t)&&document.body.removeChild(t),o&&document.body.contains(o)&&document.body.removeChild(o),window.isOverlayOpen=!1},p=l=>{i||(i=!0),r=l.clientX,n=l.clientY,o.style.position="fixed",o.style.border="2px dashed white",o.style.background="rgba(255, 255, 255, 0.3)",o.style.zIndex="100000",document.body.appendChild(o)},f=l=>{i&&(e=l.clientX,s=l.clientY,o.style.left=Math.min(r,e)+"px",o.style.top=Math.min(n,s)+"px",o.style.width=Math.abs(e-r)+"px",o.style.height=Math.abs(s-n)+"px")},L=async()=>{if(i){i=!1,w();const l=Math.min(r,e),O=Math.min(n,s),C=Math.abs(e-r),P=Math.abs(s-n),y=window.devicePixelRatio||1,I={x:l*y,y:O*y,width:C*y,height:P*y};try{const m=await new Promise(R=>{chrome.runtime.sendMessage({type:"CAPTURE_SCREEN",crop:I},R)});m.success&&m.imageUri?chrome.runtime.sendMessage({type:"CROPPED_IMAGE",imageUri:m.imageUri,crop:m.crop}):console.error("[The extension] Error capturing screen:",m)}catch(m){console.error("[The extension] Error processing crop:",m)}}},E=l=>{l.key==="Escape"&&(i&&(i=!1),w(),T())};t.addEventListener("mousedown",p),t.addEventListener("mousemove",f),document.addEventListener("mouseup",L,{once:!0}),document.addEventListener("keydown",E);const T=()=>{t.removeEventListener("mousedown",p),t.removeEventListener("mousemove",f),document.removeEventListener("keydown",E)};document.body.appendChild(t)}console.log("[The extension]: Content script loaded"),k(),b.monitorMedia()})();
