(function(){"use strict";window.hasRegisteredListener=window.hasRegisteredListener||!1,window.isOverlayOpen=window.isOverlayOpen||!1;function u(){if(window.hasRegisteredListener){console.log("[The extension]: Listener đã được đăng ký, bỏ qua...");return}chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type==="INSERT_PHOTO"&&e.photoUrl)return w(e.photoUrl).then(()=>n({success:!0})).catch(s=>n({success:!1,error:s.message})),!0;e.type==="OPEN_CROP_OVERLAY"&&(window.isOverlayOpen?console.log("[The extension]: Overlay đã mở, bỏ qua..."):m(),n({success:!0}))}),window.hasRegisteredListener=!0,console.log("[The extension]: Listener đã được đăng ký")}function m(){window.isOverlayOpen=!0;const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="rgba(0, 0, 0, 0.5)",e.style.zIndex="99999",e.style.cursor="cell";let t=0,n=0,s=0,c=0,r=!1,o=document.createElement("div");const d=()=>{e&&document.body.contains(e)&&document.body.removeChild(e),o&&document.body.contains(o)&&document.body.removeChild(o),window.isOverlayOpen=!1};e.addEventListener("mousedown",i=>{r||(r=!0),t=i.clientX,n=i.clientY,o.style.position="fixed",o.style.border="2px dashed white",o.style.background="rgba(255, 255, 255, 0.3)",o.style.zIndex="100000",document.body.appendChild(o)}),e.addEventListener("mousemove",i=>{r&&(s=i.clientX,c=i.clientY,o.style.left=Math.min(t,s)+"px",o.style.top=Math.min(n,c)+"px",o.style.width=Math.abs(s-t)+"px",o.style.height=Math.abs(c-n)+"px")}),e.addEventListener("mouseup",async i=>{if(r){r=!1,d();const y=Math.min(t,s),p=Math.min(n,c),f=Math.abs(s-t),g=Math.abs(c-n),l=window.devicePixelRatio||1,b={x:y*l,y:p*l,width:f*l,height:g*l};chrome.runtime.sendMessage({type:"CAPTURE_SCREEN",crop:b},h=>{h.success?chrome.runtime.sendMessage({type:"CROPPED_IMAGE",imageUri:h.imageUri,crop:h.crop}):console.error("[The extension] Lỗi chụp ảnh:",h.error)})}}),document.addEventListener("mouseup",i=>{r&&i.target!==e&&!e.contains(i.target)&&(console.log("[The extension]: Mouseup ngoài overlay, hủy crop"),r=!1,d())});const a=i=>{i.key==="Escape"&&(r&&(r=!1),d(),document.removeEventListener("keydown",a))};document.addEventListener("keydown",a),document.body.appendChild(e)}async function w(e){let t=document.querySelector('div[role="textbox"][contenteditable="true"]');switch(window.location.hostname){case"www.messenger.com":t=document.querySelector('div[role="textbox"][contenteditable="true"]');break;case"www.facebook.com":t=document.querySelector('div[role="textbox"][contenteditable="true"]');break;case"voz.vn":t=document.querySelector(".fr-element.fr-view.fr-element-scroll-visible");break;default:t=document.querySelector("input");break}if(!t)throw new Error("Không tìm thấy khu vực chat. Vui lòng mở box chat trước!");try{const n=await fetch(e,{mode:"cors",credentials:"omit"});if(!n.ok)throw new Error("Không thể tải ảnh từ URL");const s=await n.blob(),c=new File([s],"image.jpg",{type:s.type||"image/jpeg"}),r=new DataTransfer;r.items.add(c);const o=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:r});if(t.focus(),await new Promise(a=>setTimeout(a,50)),!t.dispatchEvent(o))throw new Error("Không thể gửi ảnh vào chat");return await new Promise(a=>setTimeout(a,100)),!0}catch(n){console.error("[The extension] Lỗi khi gửi ảnh:",n)}}console.log("[The extension]: content script loaded"),u()})();
