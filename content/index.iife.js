var S=Object.defineProperty;var I=(a,c,f)=>c in a?S(a,c,{enumerable:!0,configurable:!0,writable:!0,value:f}):a[c]=f;var y=(a,c,f)=>I(a,typeof c!="symbol"?c+"":c,f);(function(){"use strict";const u=class u{constructor(){}static getInstance(){return u.instance||(u.instance=new u),u.instance}async insertPhotoIntoMessengerChat(i){let t=this.findChatArea();if(!t)throw new Error("Không tìm thấy khu vực chat. Vui lòng mở box chat trước!");try{const e=await fetch(i,{mode:"cors",credentials:"omit"});if(!e.ok)throw new Error("Không thể tải ảnh từ URL");const o=await e.blob(),r=new File([o],"image.jpg",{type:o.type||"image/jpeg"}),s=new DataTransfer;s.items.add(r);const d=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:s});if(t.focus(),await new Promise(l=>setTimeout(l,50)),!t.dispatchEvent(d))throw new Error("Không thể gửi ảnh vào chat");return await new Promise(l=>setTimeout(l,100)),!0}catch(e){throw console.error("[The extension] Lỗi khi gửi ảnh:",e),e}}findChatArea(){switch(window.location.hostname){case"www.messenger.com":case"www.facebook.com":return document.querySelector('div[role="textbox"][contenteditable="true"]');case"voz.vn":return document.querySelector(".fr-element.fr-view.fr-element-scroll-visible");default:return document.querySelector("input")}}};y(u,"instance");let a=u;const m=class m{constructor(){y(this,"checkedElements",new Map);y(this,"maxCacheSize",1e3)}static getInstance(){return m.instance||(m.instance=new m),m.instance}async checkMediaWithBackground(i,t,e){try{return new Promise(o=>{chrome.runtime.sendMessage({type:"CHECK_NSFW",mediaUrl:i,dataSrc:t,dataSrcset:e},r=>{if(chrome.runtime.lastError){console.error("[The extension]: Lỗi khi gửi message:",chrome.runtime.lastError),o(!1);return}o(r.isNsfw||!1)})})}catch(o){return console.error("[The extension]: Lỗi khi kiểm tra media:",o),!1}}monitorMedia(){chrome.storage.local.get("config_settings-key",async i=>{var t;(t=i["config_settings-key"])!=null&&t.nsfwBlockEnabled&&(new MutationObserver(async o=>{for(const r of o)(r.addedNodes.length||r.type==="attributes")&&await this.checkNewMediaElements()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","data-src","data-srcset"]}),this.hideMediaElements(),await this.checkNewMediaElements())})}hideMediaElements(){const i=document.querySelectorAll("img, video");for(const t of Array.from(i))t.classList.add("nsfw-blur")}async checkNewMediaElements(){var t;const i=document.querySelectorAll("img, video");for(const e of Array.from(i)){const o=e.getAttribute("src")||e.getAttribute("data-src")||Math.random().toString();if(this.checkedElements.has(o))continue;let r="",s="",d="";if(e instanceof HTMLImageElement?(r=e.src,s=e.dataset.src||"",d=e.dataset.srcset||""):e instanceof HTMLVideoElement&&(r=e.src||((t=e.querySelector("source"))==null?void 0:t.src)||"",s=e.dataset.src||"",d=e.dataset.srcset||""),r||s||d){if(e.classList.add("nsfw-blur"),this.checkedElements.set(o,e),this.checkedElements.size>this.maxCacheSize){const l=this.checkedElements.keys().next().value;l&&this.checkedElements.delete(l)}await this.checkMediaWithBackground(r,s,d)||e.classList.remove("nsfw-blur")}}}};y(m,"instance");let c=m;function f(){window.hasRegisteredListener=window.hasRegisteredListener||!1,window.isOverlayOpen=window.isOverlayOpen||!1}f();const v=c.getInstance(),b=a.getInstance();function M(){if(window.hasRegisteredListener){console.log("[The extension]: Listener already registered, skipping...");return}chrome.runtime.onMessage.addListener((n,i,t)=>{if(n.type==="INSERT_PHOTO"&&n.photoUrl)return b.insertPhotoIntoMessengerChat(n.photoUrl).then(()=>t({success:!0})).catch(e=>{console.error("[The extension] Error inserting photo:",e),t({success:!1,error:e.message})}),!0;n.type==="OPEN_CROP_OVERLAY"&&(window.isOverlayOpen?console.log("[The extension]: Overlay already open, skipping..."):k(),t({success:!0}))}),window.hasRegisteredListener=!0,console.log("[The extension]: Listener registered successfully")}function k(){window.isOverlayOpen=!0;const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0, 0, 0, 0.5)",n.style.zIndex="99999",n.style.cursor="cell";let i=0,t=0,e=0,o=0,r=!1,s=document.createElement("div");const d=()=>{n&&document.body.contains(n)&&document.body.removeChild(n),s&&document.body.contains(s)&&document.body.removeChild(s),window.isOverlayOpen=!1},g=h=>{r||(r=!0),i=h.clientX,t=h.clientY,s.style.position="fixed",s.style.border="2px dashed white",s.style.background="rgba(255, 255, 255, 0.3)",s.style.zIndex="100000",document.body.appendChild(s)},l=h=>{r&&(e=h.clientX,o=h.clientY,s.style.left=Math.min(i,e)+"px",s.style.top=Math.min(t,o)+"px",s.style.width=Math.abs(e-i)+"px",s.style.height=Math.abs(o-t)+"px")},x=async()=>{if(r){r=!1,d();const h=Math.min(i,e),O=Math.min(t,o),C=Math.abs(e-i),T=Math.abs(o-t),p=window.devicePixelRatio||1,P={x:h*p,y:O*p,width:C*p,height:T*p};try{const w=await new Promise(A=>{chrome.runtime.sendMessage({type:"CAPTURE_SCREEN",crop:P},A)});w.success&&w.imageUri?chrome.runtime.sendMessage({type:"CROPPED_IMAGE",imageUri:w.imageUri,crop:w.crop}):console.error("[The extension] Error capturing screen:",w)}catch(w){console.error("[The extension] Error processing crop:",w)}}},E=h=>{h.key==="Escape"&&(r&&(r=!1),d(),L())};n.addEventListener("mousedown",g),n.addEventListener("mousemove",l),document.addEventListener("mouseup",x,{once:!0}),document.addEventListener("keydown",E);const L=()=>{n.removeEventListener("mousedown",g),n.removeEventListener("mousemove",l),document.removeEventListener("keydown",E)};document.body.appendChild(n)}console.log("[The extension]: Content script loaded"),M(),v.monitorMedia()})();
