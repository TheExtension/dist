var S=Object.defineProperty;var U=(l,c,g)=>c in l?S(l,c,{enumerable:!0,configurable:!0,writable:!0,value:g}):l[c]=g;var y=(l,c,g)=>U(l,typeof c!="symbol"?c+"":c,g);(function(){"use strict";const u=class u{constructor(){}static getInstance(){return u.instance||(u.instance=new u),u.instance}async insertPhotoIntoMessengerChat(t){let s=this.findChatArea();if(!s)throw new Error("Không tìm thấy khu vực chat. Vui lòng mở box chat trước!");try{const e=await fetch(t,{mode:"cors",credentials:"omit"});if(!e.ok)throw new Error("Không thể tải ảnh từ URL");const n=await e.blob(),i=new File([n],"image.jpg",{type:n.type||"image/jpeg"}),r=new DataTransfer;r.items.add(i);const a=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:r});if(s.focus(),await new Promise(d=>setTimeout(d,50)),!s.dispatchEvent(a))throw new Error("Không thể gửi ảnh vào chat");return await new Promise(d=>setTimeout(d,100)),!0}catch(e){throw console.error("[The extension] Lỗi khi gửi ảnh:",e),e}}findChatArea(){switch(window.location.hostname){case"www.messenger.com":case"www.facebook.com":return document.querySelector('div[role="textbox"][contenteditable="true"]');case"voz.vn":return document.querySelector(".fr-element.fr-view.fr-element-scroll-visible");default:return document.querySelector("input")}}};y(u,"instance");let l=u;const m=class m{constructor(){y(this,"checkedElements",new Map);y(this,"maxCacheSize",1e3)}static getInstance(){return m.instance||(m.instance=new m),m.instance}async checkMediaWithBackground(t,s,e){try{return new Promise(n=>{chrome.runtime.sendMessage({type:"CHECK_NSFW",mediaUrl:t,dataSrc:s,dataSrcset:e},i=>{if(chrome.runtime.lastError){console.error("[The extension]: Lỗi khi gửi message:",chrome.runtime.lastError),n(!1);return}n(i.isNsfw||!1)})})}catch(n){return console.error("[The extension]: Lỗi khi kiểm tra media:",n),!1}}monitorMedia(){chrome.storage.local.get("config_settings-key",async t=>{var s;(s=t["config_settings-key"])!=null&&s.nsfwBlockEnabled&&(new MutationObserver(async n=>{for(const i of n)(i.addedNodes.length||i.type==="attributes")&&await this.checkNewMediaElements()}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","data-src","data-srcset","xlink:href","href"]}),this.hideMediaElements(),await this.checkNewMediaElements())})}hideMediaElements(){const t=document.querySelectorAll("image, img, video");for(const s of Array.from(t))s.classList.add("nsfw-blur")}generateUniqueId(t){const s=t.getAttribute("src")||"",e=t.getAttribute("data-src")||"",n=t.getAttribute("data-srcset")||"",i=t instanceof SVGImageElement&&(t.getAttribute("xlink:href")||t.getAttribute("href"))||"";return`${t.tagName}-${s}-${e}-${n}-${i}`}async waitForImageUrl(t,s=10,e=100){return new Promise(n=>{let i=0;const r=()=>{var f;let a="";t instanceof HTMLImageElement?a=t.src:t instanceof HTMLVideoElement?a=t.src||((f=t.querySelector("source"))==null?void 0:f.src)||"":t instanceof SVGImageElement&&(a=t.getAttribute("xlink:href")||t.getAttribute("href")||""),a?n(a):i>=s?n(null):(i++,setTimeout(r,e))};r()})}async checkNewMediaElements(){var s;const t=document.querySelectorAll("image, img, video");for(const e of Array.from(t)){const n=this.generateUniqueId(e);if(this.checkedElements.has(n)){(s=this.checkedElements.get(n))!=null&&s.isNsfw&&e.classList.add("nsfw-blur");continue}let i="",r="",a="";if(e instanceof HTMLImageElement?(i=await this.waitForImageUrl(e)||"",r=e.dataset.src||"",a=e.dataset.srcset||""):e instanceof HTMLVideoElement?(i=await this.waitForImageUrl(e)||"",r=e.dataset.src||"",a=e.dataset.srcset||""):e instanceof SVGImageElement&&(console.log("[NSFW] Processing SVG image:",{mediaUrl:i,xlinkHref:e.getAttribute("xlink:href"),href:e.getAttribute("href")}),i=await this.waitForImageUrl(e)||"",r=e.dataset.src||"",a=e.dataset.srcset||""),i||r||a){if(e.classList.add("nsfw-blur"),this.checkedElements.set(n,{element:e,isNsfw:null}),this.checkedElements.size>this.maxCacheSize){const d=this.checkedElements.keys().next().value;d&&this.checkedElements.delete(d)}await this.checkMediaWithBackground(i,r,a)?this.checkedElements.set(n,{element:e,isNsfw:!0}):(this.checkedElements.set(n,{element:e,isNsfw:!1}),e.classList.remove("nsfw-blur"))}}}};y(m,"instance");let c=m;function g(){window.hasRegisteredListener=window.hasRegisteredListener||!1,window.isOverlayOpen=window.isOverlayOpen||!1}g();const b=c.getInstance(),v=l.getInstance();function k(){if(window.hasRegisteredListener){console.log("[The extension]: Listener already registered, skipping...");return}chrome.runtime.onMessage.addListener((o,t,s)=>{if(o.type==="INSERT_PHOTO"&&o.photoUrl)return v.insertPhotoIntoMessengerChat(o.photoUrl).then(()=>s({success:!0})).catch(e=>{console.error("[The extension] Error inserting photo:",e),s({success:!1,error:e.message})}),!0;o.type==="OPEN_CROP_OVERLAY"&&(window.isOverlayOpen?console.log("[The extension]: Overlay already open, skipping..."):x(),s({success:!0}))}),window.hasRegisteredListener=!0,console.log("[The extension]: Listener registered successfully")}function x(){window.isOverlayOpen=!0;const o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.background="rgba(0, 0, 0, 0.5)",o.style.zIndex="99999",o.style.cursor="cell";let t=0,s=0,e=0,n=0,i=!1,r=document.createElement("div");const a=()=>{o&&document.body.contains(o)&&document.body.removeChild(o),r&&document.body.contains(r)&&document.body.removeChild(r),window.isOverlayOpen=!1},f=h=>{i||(i=!0),t=h.clientX,s=h.clientY,r.style.position="fixed",r.style.border="2px dashed white",r.style.background="rgba(255, 255, 255, 0.3)",r.style.zIndex="100000",document.body.appendChild(r)},d=h=>{i&&(e=h.clientX,n=h.clientY,r.style.left=Math.min(t,e)+"px",r.style.top=Math.min(s,n)+"px",r.style.width=Math.abs(e-t)+"px",r.style.height=Math.abs(n-s)+"px")},M=async()=>{if(i){i=!1,a();const h=Math.min(t,e),I=Math.min(s,n),T=Math.abs(e-t),A=Math.abs(n-s),p=window.devicePixelRatio||1,O={x:h*p,y:I*p,width:T*p,height:A*p};try{const w=await new Promise(C=>{chrome.runtime.sendMessage({type:"CAPTURE_SCREEN",crop:O},C)});w.success&&w.imageUri?chrome.runtime.sendMessage({type:"CROPPED_IMAGE",imageUri:w.imageUri,crop:w.crop}):console.error("[The extension] Error capturing screen:",w)}catch(w){console.error("[The extension] Error processing crop:",w)}}},E=h=>{h.key==="Escape"&&(i&&(i=!1),a(),L())};o.addEventListener("mousedown",f),o.addEventListener("mousemove",d),document.addEventListener("mouseup",M,{once:!0}),document.addEventListener("keydown",E);const L=()=>{o.removeEventListener("mousedown",f),o.removeEventListener("mousemove",d),document.removeEventListener("keydown",E)};document.body.appendChild(o)}console.log("[The extension]: Content script loaded"),k(),b.monitorMedia()})();
