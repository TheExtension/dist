var C=Object.defineProperty;var P=(a,d,l)=>d in a?C(a,d,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[d]=l;var y=(a,d,l)=>P(a,typeof d!="symbol"?d+"":d,l);(function(){"use strict";const h=class h{constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async insertPhotoIntoMessengerChat(o){let t=this.findChatArea();if(!t)throw new Error("Không tìm thấy khu vực chat. Vui lòng mở box chat trước!");try{const e=await fetch(o,{mode:"cors",credentials:"omit"});if(!e.ok)throw new Error("Không thể tải ảnh từ URL");const i=await e.blob(),c=new File([i],"image.jpg",{type:i.type||"image/jpeg"}),s=new DataTransfer;s.items.add(c);const m=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:s});if(t.focus(),await new Promise(r=>setTimeout(r,50)),!t.dispatchEvent(m))throw new Error("Không thể gửi ảnh vào chat");return await new Promise(r=>setTimeout(r,100)),!0}catch(e){throw console.error("[The extension] Lỗi khi gửi ảnh:",e),e}}findChatArea(){switch(window.location.hostname){case"www.messenger.com":case"www.facebook.com":return document.querySelector('div[role="textbox"][contenteditable="true"]');case"voz.vn":return document.querySelector(".fr-element.fr-view.fr-element-scroll-visible");default:return document.querySelector("input")}}};y(h,"instance");let a=h;function d(n){n.style.filter="blur(20px)",n.style.transition="filter 0.3s ease"}const u=class u{constructor(){y(this,"checkedElements",new Set)}static getInstance(){return u.instance||(u.instance=new u),u.instance}async checkMediaWithBackground(o){try{return new Promise(t=>{chrome.runtime.sendMessage({type:"CHECK_NSFW",mediaUrl:o},e=>{if(chrome.runtime.lastError){console.error("[The extension]: Lỗi khi gửi message:",chrome.runtime.lastError),t(!1);return}t(e.isNsfw||!1)})})}catch(t){return console.error("[The extension]: Lỗi khi kiểm tra media:",t),!1}}monitorMedia(){new MutationObserver(async t=>{for(const e of t)e.addedNodes.length&&await this.checkNewMediaElements()}).observe(document.body,{childList:!0,subtree:!0}),this.checkNewMediaElements()}async checkNewMediaElements(){var t;const o=document.querySelectorAll("img, video, iframe, embed");for(const e of Array.from(o)){if(this.checkedElements.has(e))continue;let i="";e instanceof HTMLImageElement?i=e.src:e instanceof HTMLVideoElement?i=e.src||((t=e.querySelector("source"))==null?void 0:t.src)||"":(e instanceof HTMLIFrameElement||e instanceof HTMLEmbedElement)&&(i=e.src),i&&(this.checkedElements.add(e),await this.checkMediaWithBackground(i)&&d(e))}}};y(u,"instance");let l=u;function p(){window.hasRegisteredListener=window.hasRegisteredListener||!1,window.isOverlayOpen=window.isOverlayOpen||!1}p();const b=l.getInstance(),E=a.getInstance();function v(){if(window.hasRegisteredListener){console.log("[The extension]: Listener đã được đăng ký, bỏ qua...");return}chrome.runtime.onMessage.addListener((n,o,t)=>{if(n.type==="INSERT_PHOTO"&&n.photoUrl)return E.insertPhotoIntoMessengerChat(n.photoUrl).then(()=>t({success:!0})).catch(e=>t({success:!1,error:e.message})),!0;n.type==="OPEN_CROP_OVERLAY"&&(window.isOverlayOpen?console.log("[The extension]: Overlay đã mở, bỏ qua..."):M(),t({success:!0}))}),window.hasRegisteredListener=!0,console.log("[The extension]: Listener đã được đăng ký")}function M(){window.isOverlayOpen=!0;const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.background="rgba(0, 0, 0, 0.5)",n.style.zIndex="99999",n.style.cursor="cell";let o=0,t=0,e=0,i=0,c=!1,s=document.createElement("div");const m=()=>{n&&document.body.contains(n)&&document.body.removeChild(n),s&&document.body.contains(s)&&document.body.removeChild(s),window.isOverlayOpen=!1};n.addEventListener("mousedown",r=>{c||(c=!0),o=r.clientX,t=r.clientY,s.style.position="fixed",s.style.border="2px dashed white",s.style.background="rgba(255, 255, 255, 0.3)",s.style.zIndex="100000",document.body.appendChild(s)}),n.addEventListener("mousemove",r=>{c&&(e=r.clientX,i=r.clientY,s.style.left=Math.min(o,e)+"px",s.style.top=Math.min(t,i)+"px",s.style.width=Math.abs(e-o)+"px",s.style.height=Math.abs(i-t)+"px")}),document.addEventListener("mouseup",async r=>{if(c){c=!1,m();const k=Math.min(o,e),x=Math.min(t,i),L=Math.abs(e-o),O=Math.abs(i-t),f=window.devicePixelRatio||1,T={x:k*f,y:x*f,width:L*f,height:O*f};chrome.runtime.sendMessage({type:"CAPTURE_SCREEN",crop:T},w=>{w.success?chrome.runtime.sendMessage({type:"CROPPED_IMAGE",imageUri:w.imageUri,crop:w.crop}):console.error("[The extension] Lỗi chụp ảnh:",w.error)})}},{once:!0});const g=r=>{r.key==="Escape"&&(c&&(c=!1),m(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g),document.body.appendChild(n)}console.log("[The extension]: content script loaded"),v(),b.monitorMedia()})();
